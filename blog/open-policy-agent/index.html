
<!DOCTYPE html>
<html lang="en">

<head>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="X-UA-Compatible" content="ie=edge"/>

<script>
    (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            'gtm.start': new Date().getTime(),
            event: 'gtm.js'
        });
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src =
            'https://www.googletagmanager.com/gtm.js?id=GTM-000000' + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-000000');

</script>


<title>Home | Parameswaran V Vaidyanathan</title>
<style>
     
    .rad-fade-in {
        will-change: opacity, transform;
        animation-name: rad-fade-in-fallback;
        animation-duration: 5s;
        animation-fill-mode: both;
    }

    @keyframes rad-fade-in-fallback {
        0% {
            opacity: 0;
        }

        75% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    .fonts-loaded .rad-fade-in.rad-waiting {
        animation-name: none;
        opacity: 0;
    }

    .fonts-loaded .rad-fade-in.rad-animate {
        animation-name: rad-fade-in;
        animation-duration: 1.1s;
        animation-fill-mode: both;
    }

    @keyframes rad-fade-in {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

     
    .rad-fade-in-long {
        will-change: opacity, transform;
        animation-name: rad-fade-in-long-fallback;
        animation-duration: 8s;
        animation-fill-mode: both;
    }

    @keyframes rad-fade-in-long-fallback {
        0% {
            opacity: 0;
        }

        75% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    .fonts-loaded .rad-fade-in-long.rad-waiting {
        animation-name: none;
        opacity: 0;
    }

    .fonts-loaded .rad-fade-in-long.rad-animate {
        animation-name: rad-fade-in-long;
        animation-duration: 2s;
        animation-fill-mode: both;
    }

    @keyframes rad-fade-in-long {
        0% {
            opacity: 0;
        }

        20% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

     
    .rad-fade-down {
        will-change: opacity, transform;
        animation-name: rad-fade-down-fallback;
        animation-duration: 5s;
        animation-fill-mode: both;
        transform: translateY(-30px);
    }

    @keyframes rad-fade-down-fallback {
        0% {
            opacity: 0;
            transform: translateY(-30px);
        }

        75% {
            opacity: 0;
            transform: translateY(-30px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fonts-loaded .rad-fade-down.rad-waiting {
        animation-name: none;
        opacity: 0;
        transform: translateY(-30px);
    }

    .fonts-loaded .rad-fade-down.rad-animate {
        animation-name: rad-fade-down;
        animation-duration: 1.1s;
    }

    @keyframes rad-fade-down {
        0% {
            opacity: 0;
            transform: translateY(-30px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

     
    .rad-scale-down {
        will-change: opacity, transform;
        animation-name: rad-scale-down-fallback;
        animation-duration: 5s;
        animation-fill-mode: both;
        transform-origin: 50% 0;
    }

    @keyframes rad-scale-down-fallback {
        0% {
            opacity: 0;
            transform: scaleY(0.95);
        }

        75% {
            opacity: 0;
            transform: scaleY(0.95);
        }

        100% {
            opacity: 1;
            transform: scaleY(1);
        }
    }

    .fonts-loaded .rad-scale-down.rad-waiting {
        animation-name: none;
        opacity: 0;
        transform: scaleY(0.95);
    }

    .fonts-loaded .rad-scale-down.rad-animate {
        animation-name: rad-scale-down;
        animation-duration: 1.1s;
        animation-fill-mode: both;
    }

    @keyframes rad-scale-down {
        0% {
            opacity: 0;
            transform: scaleY(0.95);
        }

        100% {
            opacity: 1;
            transform: scaleY(1);
        }
    }
</style>


<link rel="stylesheet" href="https://parameswaranvv.github.io/css/main.css"/>

<link rel="stylesheet" href="https://parameswaranvv.github.io/css/rad-icons.css"/>

<link rel="stylesheet" href="https://parameswaranvv.github.io/css/custom.css"/>


    


</head>

<body>

<header class="header fixed-top rad-animation-group" id="header">
    <div class="container rad-fade-in">
        <nav class="navbar navbar-expand-lg navbar-light p-0" style="color: #fff; background-color: #ee6e73; width: 100%; height: 56px; line-height: 56px;">
            <a class="navbar-brand" href="https://parameswaranvv.github.io">
                <span style="color: #212529;">Param</span>
                <span>V V</span>
            </a>
            <button
                    class="navbar-toggler"
                    type="button"
                    data-toggle="collapse"
                    data-target="#navbarSupportedContent, #header"
                    aria-controls="navbarSupportedContent"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
            >
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-lg-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://parameswaranvv.github.io">HOME</a>
                    </li>
                    
                    <li class="nav-item">
                        <a data-scroll class="nav-link" href="/#about"
                        >ABOUT</a
                        >
                    </li>
                    
                    <li class="nav-item">
                        <a data-scroll class="nav-link" href="/docs/resume.pdf"
                        >RESUME</a
                        >
                    </li>
                    
                    <li class="nav-item">
                        <a data-scroll class="nav-link" href="/blog"
                        >BLOG</a
                        >
                    </li>
                    
                </ul>
            </div>
        </nav>
    </div>
</header>

<section class="rad-showcase rad-showcase--index rad-animation-group rad-fade-down" style="padding-bottom: 10px; display: contents;">

    <div class="container">
        <div class="row" style="margin-right: 0; margin-left: 0; padding-top: 15%">
            <div id="wrapper" style="width: 100%;">
                <article class="post">
                    <header>
  <div class="title">
    
      <h2><a href="/blog/open-policy-agent/">API Authorization using Open Policy Agent (OPA) as a Sidecar Container</a></h2>
    
    
      <p>Using Open Policy Agent as a Sidecar container for REST Endpoint Authorization</p>
    
  </div>
  <div class="meta">
    <time class="published" datetime="2020-04-13 15:59:28 -0500 -0500">
      April 13, 2020
    </time>
    <span class="author">Param V V</span>
    
  </div>
</header>

                    <section id="socnet-share">
                        





                    </section>
                    

                    <div class="content"> </br>
                        <aside>
                            <nav id="TableOfContents">
  <ul>
    <li><a href="#problem-statement">Problem Statement</a></li>
    <li><a href="#overview-of-opa">Overview of OPA</a>
      <ul>
        <li><a href="#key-features">Key Features</a></li>
        <li><a href="#how-does-this-help-developer-productivity">How does this help Developer Productivity?</a></li>
        <li><a href="#how-is-a-decision-made-by-the-opa-engine">How is a decision made by the OPA Engine?</a></li>
      </ul>
    </li>
    <li><a href="#practical-example---secure-rest-endpoints-using-opa">Practical Example - Secure REST Endpoints using OPA</a>
      <ul>
        <li><a href="#web-application-setup">Web application setup</a></li>
        <li><a href="#defining-opa-policies">Defining OPA Policies</a></li>
        <li><a href="#testing-our-defined-policies">Testing our defined policies</a></li>
        <li><a href="#run-locally-and-check">Run locally and check</a></li>
        <li><a href="#deploying-in-a-kubernetes-environment">Deploying in a Kubernetes Environment</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
                        </aside>
                        <h2 id="problem-statement">Problem Statement</h2>
<p>In today&rsquo;s cloud native world, authorization and policies are more complex than ever. In a typical enterprise that has been using RBAC (Role Based
Access Control) traditionally, the policy management becomes a nightmare because the need for creation of new users, roles, controls keeps growing
based on everyday&rsquo;s needs. Besides, enforcing these mammoth set of rules or policies to secure huge monolithic application makes it even more harder to
manage and maintain.</p>
<p>There are organizations where policies are managed using Excel files or Word/PDF documents, and then implemented at the ground level. This leads to
opportunities to make errors, making testing the policy changes really difficult or not possible, and rolling out new changes is extremely cumbersome.</p>
<p>OPA is a practical solution to solve these problems, especially for a cloud native world where the industry is moving to.</p>
<h2 id="overview-of-opa">Overview of OPA</h2>
<h3 id="key-features">Key Features</h3>
<ul>
<li>
<p><strong><code>Open Source</code> (backed by CNCF):</strong></p>
  <p> OPA is an `open source`, `general-purpose policy engine (of the CNCF)` that unifies policy enforcement across the stack. OPA provides a high-level declarative language that let’s you specify policy as code and simple APIs to offload policy decision-making from your software. You can use OPA to enforce policies in microservices, Kubernetes admission control, CI/CD pipelines, API gateways, and more. </p>
</li>
<li>
<p><strong>Policy Engine with <code>Policies as first-class citizens</code>:</strong></p>
  <p> OPA treats `Policies as First Class Citizens`. Policies have their own lifecycle and toolset in OPA, which means you can manage policies on their own. This allows decoupling the applications/infrastructure using the policies from the policy management itself. </p>
</li>
<li>
<p><strong>Policies can be <code>Test-Driven</code>:</strong></p>
  <p>OPA supports testing policies in isolation, which makes it more robust and scalable. In a distributed architecture world, this allows to gain more confidence by integrating the testing, and deployment process via a CI/CD pipeline.</p>
</li>
<li>
<p><strong>OPA is <code>context-aware</code> and decides based on the current context of the input, data and policy rules.</strong><br>
It means that the policy decision making uses the current context information to make the decisions. An Administrator can
modify policies based on real world current situations, and OPA would take that into consideration right away.</p>
</li>
</ul>
<p>At the outset, there are two aspects to security policy enforcement.</p>
<ul>
<li><code>Policy Enforcement</code> - This is the responsibility of the application to enforce the decisions of the policy evaluation outcomes.</li>
<li><code>Policy Decision Making</code> - This is the responsibility of the OPA Engine based on the data, input and policies available.</li>
</ul>
<p>OPA simplies this by decoupling the maintaince of policies, providing access to decision making endpoints using structured data, and enforcement.
When your software needs to make policy decisions it queries OPA and supplies structured data (e.g., JSON) as input.
OPA accepts arbitrary structured data as input.</p>
<h3 id="how-does-this-help-developer-productivity">How does this help Developer Productivity?</h3>
<p>Developers need not worry about designing the security access controls beforehand. Since the policies and decision making is decoupled, and uses the current context in time,
OPA allows the developers to focus on building the software, and parallely or later on makes changes to the authorization policies, without affecting the application.</p>
<p>Since OPA policies can be test-driven, it makes it easier to decouple the application development from the Security policies development.</p>
<div style="alignment: center"><img src="/images/OPA/OPA-Overview.png" /></div></br>
<h3 id="how-is-a-decision-made-by-the-opa-engine">How is a decision made by the OPA Engine?</h3>
<p>The OPA decision making process involves three pieces of information namely:</p>
<ul>
<li><code>Data</code> - The supporting data(in JSON) that OPA would need to make a decision. Eg: a list of ACLs with Users, Roles and Permissions to determine the access decision of a current user.</li>
<li><code>Input</code> - The request(in JSON) to OPA to determine a decision. Eg: Is a user Ken allowed access to a resource?</li>
<li><code>Policy</code> - A policy statement which specifies the logic to compute the decision using the input and data. Written in a specific language called <code>Rego</code></li>
</ul>
<h2 id="practical-example---secure-rest-endpoints-using-opa">Practical Example - Secure REST Endpoints using OPA</h2>
<p>The codebase for the below example is available <a href="https://github.com/parameswaranvv/opa-demo.git">here</a></p>
<p>The steps below outline the implementation guidelines for a sample architecture, wherein we will secure two REST Endpoints and implement
Authorization using OPA deployed as a Sidecar in a Kubernetes Pod.</p>
<p>For simplicity, the deployment architecture shows a simple Master connected with 2 worker nodes to form a cluster.</p>
<div style="alignment: center"><img src="/images/OPA/OPA_Architecture.png" /></div></br>
<h3 id="web-application-setup">Web application setup</h3>
<p>I used Spring Boot with Spring Security to expose two REST Endpoints <code>/hello</code> and <code>/bye</code>. Both the endpoints are protected by Basic Authentication using an in-memory authentication mechanism.
<strong>Note:</strong> Authentication is not really the focus of this example. The goal here is to demonstrate the authorization decision making using the login roles.</p>
<p>Assuming that you are familiar with basic Spring Boot setup, if not please use the <a href="https://start.spring.io/">Spring Initializer</a> to bootstrap a basic Spring Boot project with Web dependency.</p>
<p>The two REST endpoints are simply as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">		<span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">)</span>
		<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">sayHello</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>

		<span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bye&#34;</span><span style="color:#f92672">)</span>
		<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">sayBye</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Bye&#34;</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>
</code></pre></div><p>For a basic Spring Security setup, please refer to the sample code below. Please do not hardcode credentials in a real environment.</p>
<p><strong>WebSecurityConfiguration.java</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#a6e22e">@EnableWebSecurity</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfiguration</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>

	<span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${opa.auth.url}&#34;</span><span style="color:#f92672">)</span>
	<span style="color:#66d9ef">private</span> String opaAuthURL<span style="color:#f92672">;</span>

	<span style="color:#a6e22e">@Autowired</span>
	<span style="color:#66d9ef">private</span> AuthenticationEntryPoint authEntryPoint<span style="color:#f92672">;</span>

	<span style="color:#a6e22e">@Autowired</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configureGlobal</span><span style="color:#f92672">(</span>AuthenticationManagerBuilder auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		auth<span style="color:#f92672">.</span><span style="color:#a6e22e">inMemoryAuthentication</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
				<span style="color:#f92672">.</span><span style="color:#a6e22e">withUser</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;john123&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">password</span><span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;password&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">roles</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;USER&#34;</span><span style="color:#f92672">)</span>
				<span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
				<span style="color:#f92672">.</span><span style="color:#a6e22e">withUser</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin123&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">password</span><span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">roles</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADMIN&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Bean</span>
	<span style="color:#66d9ef">public</span> PasswordEncoder <span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
				<span style="color:#f92672">.</span><span style="color:#a6e22e">accessDecisionManager</span><span style="color:#f92672">(</span>accessDecisionManager<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
				<span style="color:#f92672">.</span><span style="color:#a6e22e">anyRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">and</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">httpBasic</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Bean</span>
	<span style="color:#66d9ef">public</span> AccessDecisionManager <span style="color:#a6e22e">accessDecisionManager</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		List<span style="color:#f92672">&lt;</span>AccessDecisionVoter<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span> <span style="color:#66d9ef">extends</span> Object<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> decisionVoters <span style="color:#f92672">=</span> Arrays
				<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> OPAVoter<span style="color:#f92672">(</span>opaAuthURL<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UnanimousBased<span style="color:#f92672">(</span>decisionVoters<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p><strong>AuthenticationEntryPoint.java</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Component</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationEntryPoint</span> <span style="color:#66d9ef">extends</span> BasicAuthenticationEntryPoint <span style="color:#f92672">{</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commence</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">,</span> AuthenticationException authEx<span style="color:#f92672">)</span>
			<span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
		response<span style="color:#f92672">.</span><span style="color:#a6e22e">addHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;WWW-Authenticate&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Basic realm=&#34;</span> <span style="color:#f92672">+</span>getRealmName<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		response<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span>HttpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">SC_UNAUTHORIZED</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		PrintWriter writer <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		writer<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HTTP Status 401 - &#34;</span> <span style="color:#f92672">+</span> authEx<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		setRealmName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;DeveloperStack&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		<span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p><strong>Note:</strong> The important thing to note here is that OPA exposes REST endpoints to allow invocations for decision making. To instruct Spring Security to interact with OPA, we create a
bean for <code>AccessDecisionManager</code> and register it. The <code>AccessDecisionManager</code> is a custom code that takes care of interaction with OPA. Sample code is below.</p>
<p><strong>OPAVoter.java</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OPAVoter</span> <span style="color:#66d9ef">implements</span> AccessDecisionVoter<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">private</span> String opaAuthURL<span style="color:#f92672">;</span>

	<span style="color:#66d9ef">private</span> RestTemplate restTemplate<span style="color:#f92672">;</span>

	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">OPAVoter</span><span style="color:#f92672">(</span>String opaAuthURL<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">opaAuthURL</span> <span style="color:#f92672">=</span> opaAuthURL<span style="color:#f92672">;</span>
		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">restTemplate</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>ConfigAttribute attribute<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">vote</span><span style="color:#f92672">(</span>Authentication authentication<span style="color:#f92672">,</span> Object obj<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>ConfigAttribute<span style="color:#f92672">&gt;</span> attributes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span><span style="color:#f92672">(</span>obj <span style="color:#66d9ef">instanceof</span> FilterInvocation<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ACCESS_ABSTAIN<span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>

		FilterInvocation filter <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FilterInvocation<span style="color:#f92672">)</span> obj<span style="color:#f92672">;</span>
		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> headers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Enumeration<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> headerNames <span style="color:#f92672">=</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getHeaderNames</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> headerNames<span style="color:#f92672">.</span><span style="color:#a6e22e">hasMoreElements</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			String header <span style="color:#f92672">=</span> headerNames<span style="color:#f92672">.</span><span style="color:#a6e22e">nextElement</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
			headers<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>header<span style="color:#f92672">,</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getHeader</span><span style="color:#f92672">(</span>header<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>

		String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> path <span style="color:#f92672">=</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestURI</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;^/|/$&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> input <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		input<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;roles&#34;</span><span style="color:#f92672">,</span> authentication<span style="color:#f92672">.</span><span style="color:#a6e22e">getAuthorities</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		input<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">,</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		input<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;path&#34;</span><span style="color:#f92672">,</span> path<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		HttpEntity<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpEntity<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> OPADataRequest<span style="color:#f92672">(</span>input<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
		OPADataResponse response <span style="color:#f92672">=</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">postForObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">opaAuthURL</span><span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> OPADataResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span>response<span style="color:#f92672">.</span><span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ACCESS_DENIED<span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>

		<span style="color:#66d9ef">return</span> ACCESS_GRANTED<span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

</code></pre></div><p><strong>OPADataRequest.java</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OPADataRequest</span> <span style="color:#f92672">{</span>

	Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> input<span style="color:#f92672">;</span>

	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">OPADataRequest</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> input<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> input<span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getInput</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">input</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p><strong>OPADataResponse.java</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OPADataResponse</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> result<span style="color:#f92672">;</span>

	<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">OPADataResponse</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	<span style="color:#f92672">}</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">result</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> result<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> result<span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>I have a pipeline that builds the application, creates the Docker image and pushes to the Docker Registry as <code>parameswaranvv/opa-web-demo:latest</code>.
<strong>Dockerfile</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:8-jdk-alpine</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> addgroup -S spring <span style="color:#f92672">&amp;&amp;</span> adduser -S spring -G spring<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> spring:spring</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DEPENDENCY<span style="color:#f92672">=</span>build/dependency<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#e6db74">${</span>DEPENDENCY<span style="color:#e6db74">}</span>/BOOT-INF/lib /app/lib<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#e6db74">${</span>DEPENDENCY<span style="color:#e6db74">}</span>/META-INF /app/META-INF<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#e6db74">${</span>DEPENDENCY<span style="color:#e6db74">}</span>/BOOT-INF/classes /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>,<span style="color:#e6db74">&#34;-cp&#34;</span>,<span style="color:#e6db74">&#34;app:app/lib/*&#34;</span>,<span style="color:#e6db74">&#34;com.example.opawebdemo.OpaWebDemoApplication&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h3 id="defining-opa-policies">Defining OPA Policies</h3>
<p>OPA uses <code>Rego</code> for defining Policies. For this example, since we have two endpoints, we will implement rules to allow access as follows:</p>
<ul>
<li><code>/hello</code> endpoint is allowed for logged in users with <code>ROLE_USER</code> role.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">allow {
  input.method == &#34;GET&#34;
  input.path = [&#34;hello&#34;]
  is_user
}
# user is allowed if he has a user role
is_user {

	# for some `i`...
	some i

  input.roles[i].authority == &#34;ROLE_USER&#34;
}
</code></pre></div><ul>
<li><code>/bye</code> endpoint is allowed for logged in users with <code>ROLE_ADMIN</code> role.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">allow {
  input.method == &#34;GET&#34;
  input.path = [&#34;bye&#34;]
  is_admin
}
# user is allowed if he has a admin role
is_admin {

	# for some `i`...
	some i

  input.roles[i].authority == &#34;ROLE_ADMIN&#34;
}
</code></pre></div><p>Putting this together, we have</p>
<p><strong>opaweb-policy.rego</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">package opaweb.authz

default allow = false

allow {
  input.method == &#34;GET&#34;
  input.path = [&#34;hello&#34;]
  is_user
}

allow {
  input.method == &#34;GET&#34;
  input.path = [&#34;bye&#34;]
  is_admin
}


# user is allowed if he has a user role
is_user {

	# for some `i`...
	some i

  input.roles[i].authority == &#34;ROLE_USER&#34;
}

# user is allowed if he has a admin role
is_admin {

	# for some `i`...
	some i

  input.roles[i].authority == &#34;ROLE_ADMIN&#34;
}
</code></pre></div><h3 id="testing-our-defined-policies">Testing our defined policies</h3>
<p>OPA allows us to test the policies in isolation, without the real need for an application. This allows us to scale and deploy policies as needed in a distributed fashion. This
is also a fantastic feature of OPA that allows us to deliver Policy changes in a CI/CD manner.</p>
<p><strong>opaweb-policy-test.rego</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">package opaweb.authz

test_hello_allowed_for_user {
    allow with input as {&#34;path&#34;: [&#34;hello&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_USER&#34;}]}
}

test_hello_denied_for_others {
    not allow with input as {&#34;path&#34;: [&#34;hello&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_ADMIN&#34;}]}
    not allow with input as {&#34;path&#34;: [&#34;hello&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_ANONYMOUS&#34;}]}
}

test_bye_allowed_for_admin {
    allow with input as {&#34;path&#34;: [&#34;bye&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_ADMIN&#34;}]}
}

test_bye_denied_for_others {
    not allow with input as {&#34;path&#34;: [&#34;bye&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_USER&#34;}]}
    not allow with input as {&#34;path&#34;: [&#34;bye&#34;], &#34;method&#34;: &#34;GET&#34;, &#34;roles&#34;: [{&#34;authority&#34;: &#34;ROLE_ANONYMOUS&#34;}]}
}
</code></pre></div><p>To run the tests, just do</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./opa test . --verbose
data.opaweb.authz.test_hello_allowed_for_user: PASS <span style="color:#f92672">(</span>623.171µs<span style="color:#f92672">)</span>
data.opaweb.authz.test_hello_denied_for_others: PASS <span style="color:#f92672">(</span>212.274µs<span style="color:#f92672">)</span>
data.opaweb.authz.test_bye_allowed_for_admin: PASS <span style="color:#f92672">(</span>184.635µs<span style="color:#f92672">)</span>
data.opaweb.authz.test_bye_denied_for_others: PASS <span style="color:#f92672">(</span>274.028µs<span style="color:#f92672">)</span>
--------------------------------------------------------------------------------
PASS: 4/4
</code></pre></div><h3 id="run-locally-and-check">Run locally and check</h3>
<ul>
<li>
<p>Instructions to run OPA locally</p>
<ul>
<li>Refer <a href="https://www.openpolicyagent.org/docs/latest/#running-opa">here</a> for instructions on downloading OPA to your machine.</li>
<li>Alternative, use Docker to spin it up instantly.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker run -p 8181:8181 openpolicyagent/opa run --server --log-level debug
</code></pre></div></li>
<li>
<p>Register the Policy definition in the OPA server using the available REST endpoint.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl --location --request PUT <span style="color:#e6db74">&#39;localhost:8181/v1/policies/opaweb/authz&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --header <span style="color:#e6db74">&#39;Content-Type: text/plain&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --data-binary @opaweb-policy.rego 
</code></pre></div></li>
<li>
<p>Run the Spring Boot application. Assuming the app is exposed on port <code>8080</code>, you can try invoking the following endpoints to received a HTTP OK response with the appropriate response body.:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -kv http://localhost:8080/hello --header <span style="color:#e6db74">&#39;Authorization: Basic am9objEyMzpwYXNzd29yZA==&#39;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -kv http://localhost:8080/bye --header <span style="color:#e6db74">&#39;Authorization: Basic YWRtaW4xMjM6YWRtaW4=&#39;</span>
</code></pre></div></li>
</ul>
<h3 id="deploying-in-a-kubernetes-environment">Deploying in a Kubernetes Environment</h3>
<p>For the above example, I created a Deployment definition yaml that I used to deploy in my Kubernetes cluster. The deployment specifies a Pod containing two containers:</p>
<ul>
<li>the webapp</li>
<li>OPA server</li>
</ul>
<p>But, how do we provide the policies to the server? Calling REST endpoints at startup, in a Production grade environment is not really recommended. Instead, we can create ConfigMaps or Secrets
with our Policy files, and mount them as volumes in the OPA Container.</p>
<p><strong>configmap.yml</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl create configmap opademo-policy --from-file<span style="color:#f92672">=</span>opaweb-policy.rego
</code></pre></div><p><strong>deployment.yml</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: opademo
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app</span>: opademo
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">app</span>: opademo
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">app</span>: opademo
      <span style="color:#66d9ef">name</span>: opademo
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
        - <span style="color:#66d9ef">name</span>: webapp
          <span style="color:#66d9ef">image</span>: parameswaranvv/opa-web-demo:latest
          <span style="color:#66d9ef">ports</span>:
            - <span style="color:#66d9ef">name</span>: http
              <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">8080</span>
          <span style="color:#66d9ef">env</span>:
            - <span style="color:#66d9ef">name</span>: opa.auth.url
              <span style="color:#66d9ef">value</span>: http://localhost:<span style="color:#ae81ff">8181</span>/v1/data/opaweb/authz/allow
        - <span style="color:#66d9ef">name</span>: opa
          <span style="color:#66d9ef">image</span>: openpolicyagent/opa:latest
          <span style="color:#66d9ef">ports</span>:
            - <span style="color:#66d9ef">name</span>: http
              <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">8181</span>
          <span style="color:#66d9ef">args</span>:
            - <span style="color:#e6db74">&#34;run&#34;</span>
            - <span style="color:#e6db74">&#34;--ignore=.*&#34;</span>  <span style="color:#75715e"># exclude hidden dirs created by Kubernetes</span>
            - <span style="color:#e6db74">&#34;--server&#34;</span>
            - <span style="color:#e6db74">&#34;/policies&#34;</span>
          <span style="color:#66d9ef">volumeMounts</span>:
            - <span style="color:#66d9ef">readOnly</span>: <span style="color:#66d9ef">true</span>
              <span style="color:#66d9ef">mountPath</span>: /policies
              <span style="color:#66d9ef">name</span>: opademo-policy
          <span style="color:#66d9ef">livenessProbe</span>:
            <span style="color:#66d9ef">httpGet</span>:
              <span style="color:#66d9ef">scheme</span>: HTTP              <span style="color:#75715e"># assumes OPA listens on localhost:8181</span>
              <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8181</span>
            <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>      <span style="color:#75715e"># tune these periods for your environemnt</span>
            <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#66d9ef">readinessProbe</span>:
              <span style="color:#66d9ef">httpGet</span>:
                <span style="color:#66d9ef">path</span>: /health?bundle=<span style="color:#66d9ef">true</span>  <span style="color:#75715e"># Include bundle activation in readiness</span>
                <span style="color:#66d9ef">scheme</span>: HTTP
                <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8181</span>
              <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
              <span style="color:#66d9ef">periodSeconds</span>: <span style="color:#ae81ff">5</span>
      <span style="color:#66d9ef">volumes</span>:
        - <span style="color:#66d9ef">name</span>: opademo-policy
          <span style="color:#66d9ef">configMap</span>:
            <span style="color:#66d9ef">name</span>: opademo-policy
</code></pre></div><p>We then go on to expose a Service for our webapp, so that we can access it via the Service.</p>
<p><strong>service.yml</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: opa-demo
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app</span>: opademo
  <span style="color:#66d9ef">ports</span>:
    - <span style="color:#66d9ef">protocol</span>: TCP
      <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8080</span>
      <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">8080</span>
</code></pre></div><p>Done!! You can test the webapp now using your Service IP address and reuse the same CURL commands from above.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/parameswaranvv/opa-demo.git">Example codebase</a></li>
<li><a href="https://www.openpolicyagent.org/docs/latest/">OPA Documentation</a></li>
<li><a href="https://opensource.com/article/19/8/open-policy-agent">Why was OPA necessary and case studies?</a></li>
</ul>

                    </div>



                </article>
                

                <div class="pagination">
                    
                    <a href="/blog/using-hugo-with-ghactions/" class="btn btn-primary" style="margin: 1em; width: 50%; color: #212529; background-color: rgba(255,255,255,0);"><div class="previous"><div>Previous: Hugo Static Site Deployment with  Github Actions</div></div></a>
                    
                    
                </div>

            </div>
        </div>
    </div>
</section>

<footer class="footer">
  <div class="container">
    <div class="footer__left">
      <div class="footer__copy">
        © Parameswaran V Vaidyanathan. All rights reserved.
      </div>
    </div>
    <div class="footer__links">
      <ul class="navbar-nav ">
        <li class="nav-item">
          <a class="nav-link" href="https://parameswaranvv.github.io/blog/open-policy-agent/">Go to Top</a>
        </li>
        
      </ul>
    </div>








  </div>
</footer>


<script src='https://parameswaranvv.github.io/js/rad-animations.js'></script>
<script src='https://parameswaranvv.github.io/js/library/lozad.min.js'></script>
<script>
  window.addEventListener("load", function() {
    var observer = window.lozad(".lozad", {
      rootMargin: window.innerHeight / 2 + "px 0px",
      threshold: 0.01
    }); 
    observer.observe();
  });
</script>
<script src='https://parameswaranvv.github.io/js/library/jquery-3.3.1.slim.min.js'></script>
<script src='https://parameswaranvv.github.io/js/library/bootstrap.min.js'></script>
<script src='https://parameswaranvv.github.io/js/sticky-header.js'></script>
<script src='https://parameswaranvv.github.io/js/library/smooth-scroll.polyfills.min.js'></script>
<script src='https://parameswaranvv.github.io/js/library/fontfaceobserver.js'></script>
<script>
  (function(w) {
    
    if (w.document.documentElement.className.indexOf("fonts-loaded") > -1) {
      return;
    }
    var fontA = new w.FontFaceObserver("Inter", {
      weight: 300
    });
    var fontB = new w.FontFaceObserver("Inter", {
      weight: 400
    });
    var fontC = new w.FontFaceObserver("Inter", {
      weight: 500
    });
    var fontD = new w.FontFaceObserver("Inter", {
      weight: 600
    });
    var fontE = new w.FontFaceObserver("Inter", {
      weight: 700
    });
    var fontF = new w.FontFaceObserver("Inter", {
      weight: 900
    });
    w.Promise.all([fontA.load(), fontC.load(), fontF.load()]).then(function() {
      w.document.documentElement.className += " fonts-loaded";
    });
  })(this);
</script>
<script>
  const scroll = new SmoothScroll('a[href*="#"]');
    $('a.nav-link').on('click', () => {
      const navbar = $('.navbar-collapse');
      if (navbar && navbar.hasClass('show')) {
        $('.navbar-toggler').click();
      }
    })
</script>

<script type="text/javascript" src="js/materialize.min.js"></script>

</body>

</html>
